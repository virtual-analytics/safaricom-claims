{% extends 'myapp/base1.html' %}
{% load humanize %}
{% block title %}Safaricom Home{% endblock %}

{% block head %}
{{ block.super }}
<!-- Include Plotly JS -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block content %}
<style>
  .dashboard-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 25px;
    padding: 30px;
  }

  .dashboard-card {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 1px 6px rgba(0, 0, 0, 0.06);
    padding: 20px;
    min-height: 400px; /* Ensure consistent height */
  }

  .card-header {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 15px;
    color: #1BB64F;
    border-bottom: 1px solid #eee;
    padding-bottom: 5px;
  }

  .table-container {
    margin-top: 1rem;
    overflow-x: auto;
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
  }

  .data-table th,
  .data-table td {
    text-align: left;
    padding: 10px;
    border-bottom: 1px solid #ddd;
    font-size: 0.95rem;
  }

  .data-table th {
    background-color: #f4f6f8;
    font-weight: 600;
  }

  .stats-container {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: stretch;
    padding: 0 30px;
    gap: 20px;
    margin-bottom: 40px;
    flex-wrap: nowrap;
    overflow-x: auto;
  }

  .stat-card {
    flex: 1;
    min-width: 200px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
    padding: 15px 20px;
    text-align: center;
    transition: 0.3s ease;
  }

  .dashboard-column {
    display: flex;
    flex-direction: column;
    gap: 25px;
    margin: 30px;
  }

  .stat-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    transform: translateY(-2px);
  }

  .stat-label {
    font-size: 0.95rem;
    color: #666;
    margin-bottom: 5px;
    font-weight: 500;
  }

  .stat-value {
    font-size: 1.6rem;
    font-weight: bold;
    color: #1BB64F;
  }

  .chart-container {
    height: 500px;
    width: 100%;
  }

  .no-data-message {
    text-align: center;
    padding: 50px 20px;
    color: #777;
    font-style: italic;
  }
  .two-column-charts {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 25px;
    margin-top: 25px;
    width: 100%;
}
/* === Date Filter & Export Styling === */
.date-filter-wrapper {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f4f8f6;
    padding: 0.8rem 1.2rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 0.8rem;
    box-shadow: 0 1px 4px rgba(0,0,0,0.05);
}

.date-filter {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.date-filter label {
    font-weight: 500;
    font-size: 0.9rem;
    color: #1BB64F;
}

.date-filter input[type="date"] {
    padding: 0.35rem 0.6rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 0.85rem;
    outline: none;
    transition: all 0.3s ease;
}

.date-filter input[type="date"]:focus {
    border-color: #1BB64F;
    box-shadow: 0 0 5px rgba(27,182,79,0.3);
}

.btn-apply, .btn-reset, .btn-export {
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.3s ease;
}

.btn-apply {
    background-color: #1BB64F;
    color: white;
}

.btn-apply:hover {
    background-color: #15963e;
}

.btn-reset {
    background-color: #f0f0f0;
    color: #444;
}

.btn-reset:hover {
    background-color: #e2e2e2;
}

.btn-export {
    background-color: #007bff;
    color: white;
}

.btn-export:hover {
    background-color: #0069d9;
}       

@media (max-width: 992px) {
    .two-column-charts {
        grid-template-columns: 1fr; /* Stack on smaller screens */
    }
}



  @media (max-width: 1024px) {
    .dashboard-container {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .dashboard-container {
      grid-template-columns: 1fr;
    }

    .stats-container {
      flex-direction: column;
      align-items: center;
    }

    .stat-card {
      width: 100%;
    }
  }
</style>

<!-- Login Message -->
<div class="login-success"
     style="background:#1BB64F; color:#fff; font-size:1.15rem; font-weight:600; padding:1.1em 1.5em; border-radius:10px; margin:0 auto 2.5rem auto; max-width:500px; text-align:center; box-shadow:0 2px 12px rgba(27,182,79,0.10); letter-spacing:0.01em;">
    You have successfully logged in, <span style="font-weight:800;">{{ username }}</span>!
</div>

<!-- Header -->
<div style="padding: 1rem 1rem 0.5rem 1rem; background-color: #ffffff; text-align: center; border-bottom: 1px solid #ddd;">
    <h2 style="color: #1BB64F; font-size: 1.75rem; font-weight: 700; margin: 0;">Claims Analytics Dashboard</h2>
    <p style="font-size: 0.95rem; color: #555; margin: 0.3rem 0 0.5rem 0;">Overview of claims data and key insights</p>
</div>

<!-- Add this below the stats container -->
<div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; background: #f1f3f5; padding: 0.75rem 1rem; margin: 1rem auto; border-radius: 8px; font-size: 0.9rem; color: #444; max-width: 1000px;">
    <div><strong>Total:</strong> {{ visualizations.summary_stats.total_claims }}</div>
    <div><strong>Cleaned:</strong> {{ visualizations.debug.cleaned_records }}</div>
    <div>
        <strong>Date Range:</strong>
        {% if visualizations.debug.min_date and visualizations.debug.max_date %}
          {{ visualizations.debug.min_date|date:"Y-m-d" }} - {{ visualizations.debug.max_date|date:"Y-m-d" }}
        {% else %}
          No valid date range
        {% endif %}
    </div>
</div>


<!-- Summary Statistics -->
<div class="stats-container">
   <div class="stat-card">
     <div class="stat-label">Total Claims</div>
     <div class="stat-value">{{ visualizations.summary_stats.total_claims|intcomma }}</div>
   </div>

    <div class="stat-card">
        <div class="stat-label">Total Amount</div>
        <div class="stat-value">KES {{ visualizations.summary_stats.total_amount|floatformat:2|intcomma }}</div>
    </div>

    <div class="stat-card">
        <div class="stat-label">Average Claim (per Member)</div>
        <div class="stat-value">KES {{ visualizations.summary_stats.avg_claim|floatformat:2|intcomma }}</div>
    </div>

    <div class="stat-card">
        <div class="stat-label">Unique Members</div>
        <div class="stat-value">{{ visualizations.summary_stats.unique_members|intcomma }}</div>
    </div>

</div>


<!--###############-->
<!-- Dashboard Columns -->


    <!-- ===== Date Range Filter ===== -->
    <div class="date-filter-wrapper">
        <div class="date-filter">
            <label>From:</label>
            <input type="date" id="startDate">
            <label>To:</label>
            <input type="date" id="endDate">
            <button id="applyDateFilter" class="btn-apply">Apply</button>
            <button id="resetDateFilter" class="btn-reset">Reset</button>
        </div>
        <button id="exportClaimsData" class="btn-export">⬇ Export Data</button>
    </div>

    <!-- Claims Over Time Chart -->
    <div class="dashboard-card">
        <div class="card-header">Claims Submitted Over Time</div>
        <div class="chart-container">
            {% if visualizations.claims_time_chart %}
                <div id="claimsTimeChart">
                    {{ visualizations.claims_time_chart|safe }}
                </div>
            {% else %}
                <div class="no-data-message">No claims data available</div>
            {% endif %}
        </div>
    </div>

<!-- Export button will be added by JS -->


    <!-- Two-column container for Benefit and Sunburst -->
    <div class="two-column-charts" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; margin-top: 25px; width: 100%;">
        <!-- Benefit Category Chart -->
        <div class="dashboard-card">
            <div class="card-header">Claim Amounts by Benefit Category</div>
            <div class="chart-container">
                {% if visualizations.category_amounts %}
                    {{ visualizations.category_amounts|safe }}
                {% else %}
                    <div class="no-data-message">No category data available</div>
                {% endif %}
            </div>
        </div>

        <!-- Sunburst Chart -->
        <div class="dashboard-card">
            <div class="card-header">Claim Amounts Breakdown (Sunburst)</div>
            <div class="chart-container">
                {% if visualizations.sunburst %}
                    {{ visualizations.sunburst|safe }}
                {% else %}
                    <div class="no-data-message">No sunburst data available</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Top Claimants -->
    <div class="dashboard-card" style="margin-top: 25px;">
        <div class="card-header">Top Claimants by Total Amount</div>
        <div class="chart-container">
            {% if visualizations.top_claimants %}
                {{ visualizations.top_claimants|safe }}
            {% else %}
                <div class="no-data-message">No claimant data available</div>
            {% endif %}
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                <tr>
                    <th>Member ID</th>
                    <th>Total Amount (KES)</th>
                    <th>Claim Count</th>
                </tr>
                </thead>
                <tbody>
                {% for claimant in visualizations.top_claimants_table %}
                <tr>
                    <td>{{ claimant.claim_me }}</td>
                    <td>{{ claimant.total_amount|floatformat:2 }}</td>
                    <td>{{ claimant.claim_count }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" style="text-align: center;">No claimant data available</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Claim Frequency Distribution -->
    <div class="dashboard-card" style="width: 100%; max-width: 100%; margin-top: 25px;">
        <div class="card-header">Claim Frequency Distribution</div>
        <div class="chart-container" style="width: 100%;">
            {% if visualizations.claim_freq %}
                {{ visualizations.claim_freq|safe }}
            {% else %}
                <div class="no-data-message">No frequency data available</div>
            {% endif %}
        </div>
    </div>



</div>

<footer style="background-color: #f8f9fa; color: #333; text-align: center; padding: 1rem 0; font-size: 0.9rem; border-top: 1px solid #ddd; margin-top: 2rem; width: 100%;">
    © 2025 Designed by Virtual Analytics, All Rights Reserved |
    <a href="#" style="color: #1BB64F; text-decoration: none; margin: 0 8px;">Terms & Conditions</a> |
    <a href="#" style="color: #1BB64F; text-decoration: none; margin: 0 8px;">Privacy Policy</a>
</footer>


<script>
// Smooth number animation
function animateValue(element, start, end, duration) {
    let startTime = null;
    const step = (timestamp) => {
        if (!startTime) startTime = timestamp;
        const progress = Math.min((timestamp - startTime) / duration, 1);
        element.textContent = end.includes("KES")
            ? "KES " + (start + (parseFloat(end.replace(/[^0-9.-]+/g,"")) - start) * progress).toLocaleString(undefined, {minimumFractionDigits: 2})
            : (start + (parseFloat(end) - start) * progress).toFixed(1) + "%";
        if (progress < 1) requestAnimationFrame(step);
    };
    requestAnimationFrame(step);
}

// Fetch and update simulation
function runSimulation() {
    let copay = document.getElementById('copay-change').value;
    let deductible = document.getElementById('deductible-change').value;
    let utilization = document.getElementById('utilization-change').value;

    fetch("{% url 'impact_simulation' %}?copay_change=" + copay +
          "&deductible_change=" + deductible +
          "&utilization_change=" + utilization, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) { alert(data.error); return; }

        // Animate Current Total
        let currentEl = document.getElementById('current-total');
        animateValue(currentEl, parseFloat(currentEl.textContent.replace(/[^0-9.-]+/g,"")), data.current_total, 800);

        // Update Projected Total + Savings %
        let projectedEl = document.getElementById('projected-total');
        projectedEl.innerHTML = data.projected_total + " ";
        let savingsPercentEl = document.createElement("span");
        savingsPercentEl.classList.add("metric-delta");
        savingsPercentEl.textContent = data.savings_percent;
        projectedEl.appendChild(savingsPercentEl);

        // Update breakdown values
        document.getElementById('copay-change-label').textContent = data.copay_change + "%";
        document.getElementById('deductible-change-label').textContent = data.deductible_change + "%";
        document.getElementById('utilization-change-label').textContent = data.utilization_change + "%";

        // Update scenario comparison dynamically
        let scenariosHTML = "";
        data.scenarios.forEach((s, i) => {
            scenariosHTML += `
                <div class="scenario ${i === 0 ? 'active' : ''}">
                    <div class="scenario-name">${s.name}</div>
                    <div class="scenario-amount">${s.amount}</div>
                    ${s.savings !== "KES 0.00" ? `<div class="scenario-savings">Save ${s.savings}</div>` : ""}
                </div>
            `;
        });
        document.getElementById('scenario-comparison').innerHTML = scenariosHTML;
    })
    .catch(err => console.error(err));
}

// Bind slider changes
function bindSlider(id, displayId) {
    let slider = document.getElementById(id);
    slider.addEventListener('input', function() {
        document.getElementById(displayId).textContent = this.value + '%';
        runSimulation(); // Auto-run simulation on change
    });
}

bindSlider('copay-change', 'copay-value');
bindSlider('deductible-change', 'deductible-value');
bindSlider('utilization-change', 'utilization-value');

// Run first simulation on page load
document.addEventListener("DOMContentLoaded", runSimulation);
</script>

{% endblock %}